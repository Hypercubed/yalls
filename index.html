<!doctype html>
<html>
<body>
INPUT:
<pre id="input">
--[[

	large block comment

--]]

-- hellp
a = 1
c, d = 2, 3
print('if 1 =', a, ', 2 =', c, ', 3 =', d, ', set is ok')
d, c = c, d
print('if 3 =', c, ', 2 =', d, ', swap is ok')

-- function calls
func f(a)
	print('if 10 =', a, ', func is ok')
end
f(10)
f2 = func(a)
	print('if 10 =', a, ', lambda is ok')
end
f2(10)
f3 = (func() return 1 end)()
print('if 1 =', f3, ', return value is ok')

-- table
e = { 1, 2, 3, k = 'v' }
print('if 1 =', e[0], ', 2 =', e[1], ', 3 =', e[2], ', get dict is ok')
print('if v =', e.k, '=', e['k'], ', get dict is ok')
e.k = 'v2'
print('if v2 =', e.k, ', set dict is ok')
e.m = { }
e.m.k = 'v3'
print('if v3 =', e.m.k, ', set nested dict is ok')

-- if statements
if 1 > 0 then
	print('if is ok')
end
if 0 > 0 then
	print('else is not ok')
else
	print('else is ok')
end
if 0 > 0 then
	print('elseif is not ok1')
elseif 0 > 0 then
	print('elseif is not ok2')
else
	print('elseif is ok')
end

-- for statements
print('if 0~4 are printed, for is ok')
for i = range(5) do
	print(i)
end
print('if 1~4 are printed, for is ok')
for i = 1, 5 do
	print(i)
end
print('if 1, 3 are printed, for is ok')
for i = 1, 2, 5 do
	print(i)
end
print('if v: k; v2: 0 are printed, pair is ok')
for v, k = pair({ ['k']='v', 'v2' }) do
	print(v, ': ', k)
end
print('if 3: 0; 2: 1; 1: 2 are printed, ipair is ok')
for v, i = ipair(array(3, 2, 1)) do
	print(v, ': ', i)
end

-- object call
print('if 1 =', $('#input').length, ', injected object is ok')
print('if input =', $('#input'):attr('id'), ', injected object is ok')


</pre>

PARSE TREE:
<pre id="tree">
</pre>

RESULT:
<div id="result">
</div>

<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js"></script>
<script src="node_modules/yajily/build/lexer.js"></script>
<script src="node_modules/yajily/build/parser.js"></script>
<script src="build/interpreter.js"></script>
<script src="build/definition.js"></script>
<script>

function format(tree, depth) {
	depth = depth || 0
	var space = Array.apply(null, Array(depth))
			.map(function(v){ return '|  '}).join('')
	if (typeof(tree) !== typeof({ })) {
		return tree + '\n'
	}
	else if (tree && 'type' in tree && 'value' in tree) {
		return tree.value + ' [' + tree.type + ']' + '\n'
	}
	else if (depth < 10) {
		var text = (tree.type ? '[' + tree.type + ']' : '' ) + '\n'
		for (var key in tree) {
			if (tree.hasOwnProperty(key) && key !== 'type')
				text += space + key + ': ' + format(tree[key], depth + 1)
		}
		return text
	}
}

function compile(tree) {
	if (Array.isArray(tree))
		return tree.map(compile)
	else if (tree === undefined || tree === null)
		return 'nil'
	else if (tree.type === 'STR')
		return '"' + tree.value
	else if (tree.value !== undefined)
		return tree.value
	else
		return tree
}

function execute(input, table) {
	var tokens = lex(input, definition.actions),
		tree = parse(tokens, definition.grammars, table, definition.precedence),
		code = compile(tree)
	$('#tree').text(format(code))
	evaluate(code, env)
}

var env = evaluate.rootenv()
// inject print function
env('print', function() {
	$('#result').append('<pre>' +
		Array.prototype.slice.call(arguments).join(' ') +
	'</pre>')
})
env('$', $)

// load compiled table
$.get('build/table.json', function(table) {
	execute($('#input').text(), table)
})

</script>
</body>
</html>