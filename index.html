<!doctype html>
<html>
<body>
INPUT:
<pre id="input">
--[[

	large block comment

--]]

-- hellp
a = 1
c, d = 2, 3
print('set ok', a, c, d)
d, c = c, d
print('swap ok', c, d)

-- function calls
func f(a)
	print('func ok', a)
end
f(10)
f2 = func(a)
	func p()
		return a * a
	end
	print('lambda ok', p())
end
f2(10)

-- table
e = { 1, 2, 3, k = 'dict get ok' }
print('dict ok', e)
k = 'k'
print(e[k])
print(e.k)
print(e['k'])
e.k = 'dict set ok'
print(e.k)

-- if statements
if 1 > 0 then
	print('if ok')
end
if 0 > 0 then
	print('else ok1')
else
	print('else ok2')
end
if 0 > 0 then
	print('elseif ok1')
elseif 0 > 0 then
	print('elseif ok2')
else
	print('elseif ok3')
end

-- for statements
print('for from 0~4')
for i = range(5) do
	print(i)
end
print('for from 1~4')
for i = 1, 5 do
	print(i)
end
print('for with 1, 3')
for i = 1, 2, 5 do
	print(i)
end
print('for in dict')
for v, k = pair({ ['ok']='for loop', 'hi' }) do
	print('  ', v, ': ', k)
end
print('for in array')
for v, i = ipair(array(1, 2, 3)) do
	print('  ', v, ': ', i)
end

</pre>

PARSE TREE:
<pre id="tree">
</pre>

RESULT:
<div id="result">
</div>

<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js"></script>
<script src="node_modules/yajily/build/lexer.js"></script>
<script src="node_modules/yajily/build/parser.js"></script>
<script src="build/interpreter.js"></script>
<script src="build/definition.js"></script>
<script>

function format(tree, depth) {
	depth = depth || 0
	var space = Array.apply(null, Array(depth))
			.map(function(v){ return '|  '}).join('')
	if (typeof(tree) !== typeof({ })) {
		return tree + '\n'
	}
	else if (tree && 'type' in tree && 'value' in tree) {
		return tree.value + ' [' + tree.type + ']' + '\n'
	}
	else if (depth < 10) {
		var text = (tree.type ? '[' + tree.type + ']' : '' ) + '\n'
		for (var key in tree) {
			if (tree.hasOwnProperty(key) && key !== 'type')
				text += space + key + ': ' + format(tree[key], depth + 1)
		}
		return text
	}
}

function compile(tree) {
	if (Array.isArray(tree))
		return tree.map(compile)
	else if (tree === undefined || tree === null)
		return 'nil'
	else if (tree.type === 'STR')
		return '"' + tree.value
	else if (tree.value !== undefined)
		return tree.value
	else
		return tree
}

function execute(input, table) {
	var tokens = lex(input, definition.actions),
		tree = parse(tokens, definition.grammars, table, definition.precedence),
		code = compile(tree)
	$('#tree').text(format(code))
	evaluate(code, env)
}

var env = evaluate.rootenv()
// inject print function
env('print', function() {
	$('#result').append('<pre>' +
		Array.prototype.slice.call(arguments).join(' ') +
	'</pre>')
})
// load compiled table
$.get('build/table.json', function(table) {
	execute($('#input').text(), table)
})

</script>
</body>
</html>