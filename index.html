<!doctype html>
<html>
<head>
<style>
a {
	text-decoration: none;
}
a:hover {
	text-decoration: underline;
}
.node {
	font-size: 80%;
	display: none;
	margin-left: 1em;
}
</style>
</head>
<body>
<select id="code_samples"></select>
<button onclick="execute()">Execute</button>
<small id="time"></small>
<div id="input" style="width:100%;height:360px" rows="10">
</div>
<script title="yield with call/cc" type="script/x-lua">
mkYield = fn(ret, next)
	next = fn(cc, value)
		fn()
			callcc(fn(rcc)
				ret = rcc
				cc(value)
			end)
		end
	end
	fn(value)
		callcc(fn(cc)
			ret({ next = next(cc, value), value })
		end)
	end
end

mkGenerator = fn(iter, next)
	next = fn()
		callcc(fn(cc)
			yield = mkYield(cc)
			iter(yield)
		end)
	end
	fn()
		if next then
			n = next()
			next = n.next
			n.value
		end
	end
end

iter = mkGenerator(fn(yield)
    yield(1)

    echo('[i] yielding in if')
    if yield(2) then
    	yield(3)
    else
    	yield(4)
    end

    echo('[i] yielding in function')
    f = fn() yield('a') end
    f()
    f()
    f()

end)

$('<button>Yield</button>').click(fn(e)
	echo(iter())
end).appendTo('#result')


</script>
<script title="loop with call/cc" type="script/x-lua">
let count = 0
	kont = nil do

	if not kont then
		callcc(fn(cc)
			kont = cc
		end)
	end

	echo("go x{{ count }}")

	if count < 10 then
		count = count + 1
		kont()
	end

end
</script>
<script title="object meta method" type="script/x-lua">
lookup = self['@']

a = self.new(
        name = 'a'
		say = fn()
		    echo('my name is ' + self.name)
		end
		'@' = fn(name)
		    lookup.call(self, name) or fn()
		        echo("[!] this guy ({{ self.name }}) " +
		        	"cannot {{ name }} ")
		    end
		end)
a.say()

b = a.new(name = 'b')
b.say()

b.cry()
</script>
<script title="dsl (html)" type="script/x-lua">
htmlBuilder = fn(env)
	css = fn()
		(for v, k = pair(arga) do
			"{{ k }}:{{ v }}"
		end).join(';')
	end
	env['@'] = fn(name)
		local[name] or fn()
			attrs = for v, k = pair(arga) do "{{ k }}=\"{{ v }}\"" end
			tag = attrs.length and name + ' ' + attrs.join(' ') or name
			if args.length then
				"<{{ tag }}>{{ args.join('') }}</{{ name }}>"
			else
				"<{{ tag }} />"
			end
		end
	end
end

text = do htmlBuilder(local)

	div(class="main"
		h1(id="title"
			'Hello World!')
		p(style=css(color="red", 'font-size'="200%")
			'from ', big('#3512'))
		input(onclick="alert('ya')", type="submit"))

end

console.log(text)
$('#result').append(text)

</script>
<div id="tree"></div>
<pre id="console"></pre>
<pre id="result"> loading... </pre>

<script src="//libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/mode-lua.js"></script>
<script src="../yajily/build/lexer.js"></script>
<script src="../yajily/build/parser.js"></script>
<script src="build/cekvm.js"></script>
<script src="build/grammar.js"></script>
<script src="build/prelude.js"></script>
<script>

	function format(tree, depth) {
		depth = depth || 0
		if (typeof(tree) !== typeof({ })) {
			return tree
		}
		else if (depth < 50) {
			var children = [ ]
			for (var key in tree)
				if (tree.hasOwnProperty(key))
					children.push('<div class="item">' + 
						key + ': ' + format(tree[key], depth + 1) + '</div>')
			return '<a href onclick="$(this).next().toggle();return false">&gt;</a>' + 
				'<div class="node">' +
					children.join('') + '</div>'
		}
	}

	function compile(tree) {
		if (Array.isArray(tree))
			return tree.map(compile)
		else if (tree === null || tree === undefined)
			return undefined
		else if (tree.type === 'STR')
			return '"' + tree.value
		else if (tree.value !== undefined)
			return tree.value
		else
			return tree
	}

	function execute() {
		if (!table) return
		$('#result').empty()
		$('#console').empty()
		$('#tree').empty()
		try {
			var input = editor.getValue(),
				tree = grammar.parse(input, table),
				code = compile(tree)
			$('#tree').html(format(code))

			var tickStart = Date.now()
			evaluate(code, evaluate.environment(env))
			$('#time').text((Date.now() - tickStart) + 'ms')
		}
		catch (e) {
			console.log(e)
			$('#result').text('EvaluateError: ' + e)
		}
	}

	var env = evaluate.environment(null, prelude)
	env('echo', function() {
		var content = Array.prototype.slice.call(arguments)
			.map(function(a) { return '' + a }).join(' ')
		$('<pre></pre>').text(content).appendTo('#console')
	})
	env('console', console)
	env('$', $)

	// compiled table, will be loaded later
	var table
	$.get('build/table.json', function(t) {
		table = t
		execute()
	})

</script>
<script>

	var editor = ace.edit('input')
	editor.getSession().setMode('ace/mode/lua')
	editor.$blockScrolling = Infinity

</script>
<script>

	var select = $('#code_samples')

	$('script[type="script/x-lua"]').each(function(i, e) {
		if (!e.id) e.id = 'script' + i
		select.append('<option value="' + e.id + '"">' + e.title + '</option>')
	})

	select.bind('change', function(e) {
		location.hash = $(this).val()
	})

	$(window).on('hashchange', function(e) {
		select.val(location.hash.substr(1))
		editor.setValue($(location.hash).text(), -1)
		execute()
	})

	if (!location.hash.substr(1))
		location.hash = select.val()
	else
		$(window).trigger('hashchange')

</script>
</body>
</html>
