<!doctype html>
<html>
<body>
<b>INPUT</b>:
<button onclick="execute()">Execute</button>
<div id="input" style="width:100%;height:360px" rows="10">
</div>
<script id="input_sample" type="script/x-lua">
htmlBuilder = fn(env)
  env.get = fn(name)
    prelude.get(name) or fn()
      attrs = for v, k = pair(arga) do "{{ k }}=\"{{ v }}\"" end
      tag = attrs.length and name + ' ' + attrs.join(' ') or name
      if args.length then
      	"<{{ tag }}>{{ args.join('') }}</{{ name }}>"
      else
      	"<{{ tag }} />"
      end
    end
  end
end

text = do htmlBuilder(local)

  div(class="main"
    h1(id="title"
      'Hello World!')
    p(style="color:blue"
      'from ', big('#3512'))
    input(onclick="alert('ya')", type="submit"))

end

console.log(text)
$('#result').append(text)

</script>
<b>RESULT</b>:
<button onclick="$('#tree').toggle()">show parse tree</button>
<pre id="tree" style="display:none"></pre>
<div id="result"> loading... </div>
<small id="time"></small>

<script src="//libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/mode-lua.js"></script>
<script src="../yajily/build/lexer.js"></script>
<script src="../yajily/build/parser.js"></script>
<script src="build/interpreter.js"></script>
<script src="build/grammar.js"></script>
<script src="build/prelude.js"></script>
<script>

	var editor = ace.edit('input')
	editor.getSession().setMode('ace/mode/lua')
	editor.setValue($('#input_sample').text(), 1)

</script>
<script>

function format(tree, depth) {
	depth = depth || 0
	var space = Array.apply(undefined, Array(depth))
			.map(function(v){ return '|  '}).join('')
	if (typeof(tree) !== typeof({ })) {
		return tree + '\n'
	}
	else if (depth < 50) {
		var text = '\n'
		for (var key in tree)
			if (tree.hasOwnProperty(key))
				text += space + key + ': ' + format(tree[key], depth + 1)
		return text
	}
}

function compile(tree) {
	if (Array.isArray(tree))
		return tree.map(compile)
	else if (tree === null)
		return undefined
	else if (tree.type === 'STR')
		return '"' + tree.value
	else if (tree.value !== undefined)
		return tree.value
	else
		return tree
}

function execute() {
	if (!table) return
	$('#result').empty()
	$('#tree').empty()
	try {
		var input = editor.getValue(),
			tree = grammar.parse(input, table),
			code = compile(tree)
		$('#tree').text(format(code))

		var tickStart = Date.now()
		evaluate(code, env)
		$('#time').text((Date.now() - tickStart) + 'ms')
	}
	catch (e) {
		$('#result').text(e)
	}
}

var env = evaluate.environment(null, prelude)
env.update('echo', function() {
	$('<pre></pre>')
		.text(Array.prototype.slice.call(arguments).join(' '))
		.appendTo('#result')
})
env.update('prelude', env.clone())
env.update('console', console)
env.update('$', $)

// compiled table, will be loaded later
var table
$.get('build/table.json', function(t) {
	table = t
	execute()
})

</script>
</body>
</html>
